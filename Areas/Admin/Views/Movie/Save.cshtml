@model AdminMovieSaveVM

<h1 class="m-5 my-4">Create New Movie</h1>
<link href="~/css/select2.css" rel="stylesheet" />


<div class="row">
	<div class="col-3"></div>
	<div class="col-8 d-flex">
		<div class="card shadow mx-auto col-md-6 d-flex ">
			<div class="card-body p-4">
				<form asp-action="Save" method="post" enctype="multipart/form-data">
					<div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>
					<input asp-for="Movie.Id" type="hidden" />
					<div class="mb-3">
						<label asp-for="Movie.Name" class="form-label"></label>
						<input asp-for="Movie.Name" class="form-control" />
						<span asp-validation-for="Movie.Name" class="text-danger"></span>
					</div>

					<div class="mb-3">
						<label asp-for="Movie.Description" class="form-label"></label>
						<textarea asp-for="Movie.Description" rows="3" class="form-control"></textarea>
						<span asp-validation-for="Movie.Description" class="text-danger"></span>
					</div>

					<div class="mb-3">
						<label asp-for="Movie.Price" class="form-label"></label>
						<input asp-for="Movie.Price" type="number" step="0.01" class="form-control" />
						<span asp-validation-for="Movie.Price" class="text-danger"></span>
					</div>

					<div class="mb-3">
						<label asp-for="Movie.ImgUrl" class="form-label"></label>
						<input asp-for="ImgFile" class="form-control" type="file" onchange="previewImage(event)" />
						<span asp-validation-for="Movie.ImgUrl" class="text-danger"></span>
					</div>

					<div class="mb-3">
						<label asp-for="Movie.TrailerUrl" class="form-label"></label>
						<input asp-for="Movie.TrailerUrl" class="form-control" />
						<span asp-validation-for="Movie.TrailerUrl" class="text-danger"></span>
					</div>

					<div class="mb-3">
						<label asp-for="Movie.StartDate" class="form-label"></label>
						<input asp-for="Movie.StartDate" type="date" class="form-control" />
						<span asp-validation-for="Movie.StartDate" class="text-danger"></span>
					</div>

					<div class="mb-3">
						<label asp-for="Movie.EndDate" class="form-label"></label>
						<input asp-for="Movie.EndDate" type="date" class="form-control" />
						<span asp-validation-for="Movie.EndDate" class="text-danger"></span>
					</div>

					<div class="mb-3">
						<label asp-for="Movie.MovieDisplayStateId" class="form-label"></label>
						<select asp-for="Movie.MovieDisplayStateId" class="form-select" asp-items="Model.MovieStatus">
							<option value="">-- Select State --</option>
						</select>
						<span asp-validation-for="Movie.MovieDisplayStateId" class="text-danger"></span>
					</div>

					<div class="mb-3">
						<label asp-for="Movie.CinemaId" class="form-label"></label>
						<select asp-for="Movie.CinemaId" class="form-select" asp-items="Model.Cinemas">
							<option value="">-- Select Cinema --</option>
						</select>
						<span asp-validation-for="Movie.CinemaId" class="text-danger"></span>
					</div>

					<div class="mb-3">
						<label asp-for="Movie.CategoryId" class="form-label"></label>
						<select asp-for="Movie.CategoryId" class="form-select" asp-items="Model.Categories">
							<option value="">-- Select Category --</option>
						</select>
						<span asp-validation-for="Movie.CategoryId" class="text-danger"></span>
					</div>
					<div class="mb-3">
						<label asp-for="ActorIds">Select Actors</label>
						<select asp-for="Actor.Id" asp-items="Model.Actors" multiple="multiple" class="form-control" name="ActorIds" data-val="false"></select>
						<span asp-validation-for="ActorIds" class="text-danger"></span>

					</div>
					<div class="mb-3 form-check">
						<input asp-for="Movie.MovieStatus" type="checkbox" class="form-check-input" />
						<label asp-for="Movie.MovieStatus" class="form-check-label"></label>
					</div>


					<div class="d-flex justify-content-between align-items-center mt-4">
						<button type="submit" class="btn btn-primary">Create</button>
						<a asp-action="Index" class="btn btn-secondary">Back to List</a>
					</div>

				</form>
			</div>
		</div>
		<div class="col-md-4 offset-md-1 d-flex align-items-center justify-content-center m-0">
			@if (Model.Movie.ImgUrl != null)
			{
				<img src="~/images/movies/@Model.Movie.ImgUrl" id="preview" class="img-thumbnail align-" style="max-width: 100%; align-self :start;" />
			}
			else
			{
				<img src="~/images/movies/@Model.Movie.ImgUrl" alt="Not found" id="preview" class="img-thumbnail" style="max-width: 100%; display: none;  align-self :start;" />

			}
		</div>

		<div id="actorContainer" data-actors='@Html.Raw(Json.Serialize(Model.ActorIds))'></div>

	</div>
	<div id="actorDetails" class="mt-4">
	</div>
</div>

@section Scripts {
	@{
		await Html.RenderPartialAsync("_ValidationScriptsPartial");
	}
	<script src="~/lib/jquery/dist/Select2.js"></script>

	<script>
		$("#Movie.ImgUrl").on("change", previewImage);

		function previewImage(event) {
			const input = event.target;
			const preview = document.getElementById('preview');

			if (input.files && input.files[0]) {
				const reader = new FileReader();

				reader.onload = function (e) {
					preview.src = e.target.result;
					preview.style.display = 'block';
				};

				reader.readAsDataURL(input.files[0]);
			} else {
				preview.src = '';
				preview.style.display = 'none';
			}
		}

		  $('#Actor_Id').select2({
			placeholder: "Choose actors",
			allowClear: true,
		  });
			placeActorsToSelectList();

			function placeActorsToSelectList() {
			const selectedActorIds = JSON.parse($('#actorContainer')[0].dataset.actors);
			$('#Actor_Id').val(selectedActorIds).trigger('change');
			 selectedActorIds.forEach((actorId) => {
			getActorData(actorId);
			 });
			}

			var list = [];

			$('#Actor_Id').on('select2:unselect', function (e) {
			const removedId = e.params.data.id;
			$('#actorDetails').find(`#${removedId}`).remove();

			 });

			$('#Actor_Id').on('select2:select', function (e) {
			var ActorId = e.params.data.id;
			getActorData(ActorId)
		});

		function getActorData(ActorId) {
			 $.ajax({
				url: '@Url.Action("GetActorData", "Movie")',
				type: 'GET',
				data: { id: ActorId },
				success: function (data) {
				if (data && data.actorData) {
				var actorHtml = `
				<div id="${data.actorData.id}">
					   <input type="hidden" name="ActorIds" value="${data.actorData.id}" />
				   <div class="actor-card" style="margin-left: 60px;margin-top: 5px;">
						<img src="${data.actorData.image}" alt="${data.actorData.name}" class="actor-image " />
						<span class="actor-name">${data.actorData.name}</span>
					</div>
				</div>`;
				$('#actorDetails').append(actorHtml);
			  }
				}
			});
		}

	</script>

}
